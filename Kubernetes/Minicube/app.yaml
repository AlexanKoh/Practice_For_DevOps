apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: website-storage
  namespace: my-app
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Gi

---

# PHP-FPM
apiVersion: apps/v1
kind: Deployment
metadata:
  name: php-fpm
  namespace: my-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: php-fpm
  template:
    metadata:
      labels:
        app: php-fpm
    spec:
      containers:
      - name: php-fpm
        image: php:8.2-fpm
        ports:
        - containerPort: 9000
        volumeMounts:
        - name: website-files
          mountPath: /var/www/html
        resources:
          limits:
            cpu: 500m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi
      volumes:
      - name: website-files
        persistentVolumeClaim:
          claimName: website-storage

---

apiVersion: v1
kind: Service
metadata:
  name: php-service
  namespace: my-app
spec:
  selector:
    app: php-fpm
  ports:
    - protocol: TCP
      port: 9000
      targetPort: 9000

---

# Website (Nginx)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: website
  namespace: my-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: website
  template:
    metadata:
      labels:
        app: website
    spec:
      initContainers:
      - name: copy-website-files
        image: ghcr.io/alexankoh/website:latest
        command: ["sh", "-c", "cp -r /var/www/html/* /shared-website/"]
        volumeMounts:
        - name: website-files
          mountPath: /shared-website
      containers:
      - name: website
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        - name: website-files
          mountPath: /var/www/html
        command: 
        - /bin/sh
        - -c
        - |
          cat > /etc/nginx/conf.d/default.conf << 'EOF'
          server {
              listen 80;
              server_name localhost;
              root /var/www/html;
              index index.php index.html;

              location / {
                  try_files $uri $uri/ /index.php$is_args$args;
              }

              location ~ \.php$ {
                  fastcgi_pass php-service:9000;
                  fastcgi_index index.php;
                  include fastcgi_params;
                  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
              }
          }
          EOF
          nginx -g "daemon off;"
      volumes:
      - name: website-files
        persistentVolumeClaim:
          claimName: website-storage

---

apiVersion: v1
kind: Service
metadata:
  name: nginx-service
  namespace: my-app
spec:
  selector:
    app: website
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
